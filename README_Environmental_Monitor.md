# 环境监测器 - ILI9488显示版本

这是一个基于Raspberry Pi Pico的环境监测器项目，使用ILI9488 3.5寸彩色显示屏显示AHT20和BMP280传感器的数据。

## 功能特性

- **实时数据采集**：AHT20温湿度传感器 + BMP280气压传感器
- **美观的显示界面**：参考"ENVIRONMENTAL MONITOR"样式的卡片式布局
- **局部刷新**：只更新变化的数据，避免全屏刷新
- **数据滤波**：内置压力数据滤波算法
- **错误处理**：传感器初始化失败时显示错误信息
- **夜间模式**：深色背景，浅色文字，护眼设计

## 硬件要求

### 主要硬件
- **Raspberry Pi Pico** (或Pico W)
- **ILI9488 3.5寸TFT显示屏** (320x480分辨率)
- **AHT20温湿度传感器**
- **BMP280气压传感器**

### 引脚连接

#### ILI9488显示屏 (SPI0)
| Pico GPIO | ILI9488引脚 | 功能 |
|-----------|-------------|------|
| GPIO20    | DC          | 数据/命令选择 |
| GPIO15    | RST         | 复位 |
| GPIO16    | BL          | 背光控制 |
| GPIO17    | CS          | 片选 |
| GPIO18    | SCK         | SPI时钟 |
| GPIO19    | MOSI        | SPI数据 |

#### 传感器 (I2C1)
| Pico GPIO | 传感器引脚 | 功能 |
|-----------|------------|------|
| GPIO6     | SDA        | I2C数据线 |
| GPIO7     | SCL        | I2C时钟线 |

#### 电源连接
- **VCC**: 3.3V
- **GND**: 接地

## 编译和烧录

### 1. 环境准备
确保已安装：
- Pico SDK
- CMake
- ARM GCC工具链

### 2. 编译项目
```bash
# 创建构建目录
mkdir build
cd build

# 配置项目
cmake ..

# 编译
make environmental_monitor
```

### 3. 烧录固件
将生成的`environmental_monitor.uf2`文件复制到Pico的BOOTSEL模式。

## 显示界面说明

### 界面布局
```
┌─────────────────────────────────────┐
│        ENVIRONMENTAL MONITOR        │
│ ─────────────────────────────────── │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ AHT20                           │ │
│ │ Temperature                     │ │
│ │ 29.2°C                    Normal│ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ AHT20                           │ │
│ │ Humidity                        │ │
│ │ 59.2%                     Normal│ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ BMP280                          │ │
│ │ Pressure                        │ │
│ │ 1012.5691hPa              Normal│ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ BMP280                          │ │
│ │ Temperature                     │ │
│ │ 29.95°C                   Normal│ │
│ └─────────────────────────────────┘ │
│                                     │
│ AVERAGE: 29.58°C                   │
└─────────────────────────────────────┘
```

### 数据说明
- **AHT20温度**：精度0.1°C
- **AHT20湿度**：精度0.1%
- **BMP280气压**：精度0.0001hPa
- **BMP280温度**：精度0.01°C
- **平均温度**：AHT20和BMP280温度的平均值

## 技术特性

### 局部刷新机制
- 只有当数据变化超过阈值时才更新显示
- 只刷新数值区域，保持界面稳定
- 支持不同精度的数值显示

### 数据滤波
- BMP280压力数据使用5点滤波算法
- 减少数据抖动，提高显示稳定性

### 错误处理
- 传感器初始化失败时显示错误信息
- 自动重试机制
- 友好的错误提示界面

## 自定义配置

### 修改刷新阈值
在`EnvironmentalMonitor.cpp`中修改：
```cpp
// 温度变化阈值
if (fabs(new_data.aht20_temperature - current_data_.aht20_temperature) > 0.1f)

// 湿度变化阈值  
if (fabs(new_data.aht20_humidity - current_data_.aht20_humidity) > 0.1f)

// 气压变化阈值
if (fabs(new_data.bmp280_pressure - current_data_.bmp280_pressure) > 0.01f)
```

### 修改显示颜色
在`ili9488_colors.hpp`中定义的颜色：
```cpp
static constexpr uint32_t LIGHT_BLUE = 0x8080FC;  // 主要文字颜色
static constexpr uint32_t GREEN = 0x00FC00;       // 状态正常颜色
static constexpr uint32_t RED = 0xFC0000;         // 错误状态颜色
```

### 修改刷新频率
在主循环中修改延时：
```cpp
delay_ms(1000);  // 1秒刷新一次
```

## 故障排除

### 常见问题

1. **显示屏不亮**
   - 检查背光引脚连接
   - 确认电源电压为3.3V
   - 检查SPI引脚连接

2. **传感器数据异常**
   - 检查I2C连接
   - 确认传感器地址正确
   - 检查电源电压

3. **编译错误**
   - 确认Pico SDK路径正确
   - 检查CMake配置
   - 确认所有依赖文件存在

### 调试信息
程序会通过USB串口输出调试信息：
```
=== 环境监测器 - ILI9488显示版本 ===
版本: v1.0.0
显示屏: ILI9488 3.5寸 (320x480)
传感器: AHT20 + BMP280
====================================
[HARDWARE] 开始初始化硬件...
[HARDWARE] 初始化I2C...
[HARDWARE] 初始化ILI9488显示屏...
[HARDWARE] ILI9488显示屏初始化完成
[HARDWARE] 初始化环境监测显示模块...
[ENV_MONITOR] 显示界面初始化完成
[HARDWARE] 环境监测显示模块初始化完成
[HARDWARE] 初始化AHT20传感器...
[HARDWARE] AHT20传感器初始化完成
[HARDWARE] 初始化BMP280传感器...
[HARDWARE] BMP280传感器初始化完成
[HARDWARE] 所有硬件初始化完成
[MAIN] 开始主循环...
[DATA] AHT20: 25.3°C, 65.2% | BMP280: 25.1°C, 1013.2500hPa, 45.2m | 平均: 25.20°C
```

## 许可证

本项目采用MIT许可证。

## 更新日志

### v1.0.0
- 初始版本
- 支持AHT20和BMP280传感器
- ILI9488显示界面
- 局部刷新功能
- 数据滤波算法
